<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Posts - Sistema Educacional</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #4e73df;
      --primary-dark: #2e59d9;
      --success-color: #1cc88a;
      --warning-color: #f6c23e;
      --danger-color: #e74a3b;
      --info-color: #36b9cc;
      --text-dark: #2e384d;
      --text-light: #858796;
      --shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
    
    .page-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
      border-radius: 0 0 20px 20px;
    }
    
    .post-card {
      border: none;
      border-radius: 12px;
      box-shadow: var(--shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    
    .post-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 0.5rem 2rem 0 rgba(58, 59, 69, 0.2);
    }
    
    .post-card.pinned {
      border-left: 4px solid var(--warning-color);
      background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
    }
    
    .post-header {
      padding: 1.25rem 1.5rem 0.5rem;
      border-bottom: 1px solid #e3e6f0;
    }
    
    .post-body {
      padding: 1rem 1.5rem;
    }
    
    .post-footer {
      padding: 0.75rem 1.5rem;
      background-color: #f8f9fc;
      border-top: 1px solid #e3e6f0;
    }
    
    .badge-type {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-general { background-color: var(--primary-color); }
    .badge-important { background-color: var(--danger-color); }
    .badge-event { background-color: var(--success-color); }
    .badge-announcement { background-color: var(--info-color); }
    
    .author-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .create-post-card {
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-light);
    }
    
    .btn-action {
      border-radius: 6px;
      margin-right: 5px;
    }
    
    .pinned-indicator {
      color: var(--warning-color);
      font-size: 0.9rem;
    }
    
    .stats-card {
      background: white;
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
      margin-bottom: 1.5rem;
    }
    
    .time-ago {
      font-size: 0.875rem;
      color: var(--text-light);
    }
  </style>
</head>
<body class="bg-light">
  <!-- Cabeçalho -->
  <div class="page-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1><i class="bi bi-chat-dots"></i> Posts e Avisos</h1>
          <p class="lead mb-0">Compartilhe informações e mantenha todos atualizados</p>
        </div>
        <div class="col-md-4 text-md-end">
          <a href="/home" class="btn btn-light btn-lg">
            <i class="bi bi-arrow-left"></i> Voltar para Home
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Estatísticas -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="stats-card">
          <h3 class="text-primary" th:text="${#lists.size(posts)}">0</h3>
          <p class="mb-0 text-muted">Total de Posts</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card">
          <h3 class="text-warning" th:text="${#lists.size(posts.?[pinned])}">0</h3>
          <p class="mb-0 text-muted">Posts Fixados</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card">
          <h3 class="text-info" th:text="${#lists.size(posts.?[type.name() == 'IMPORTANT'])}">0</h3>
          <p class="mb-0 text-muted">Importantes</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card">
          <h3 class="text-success" th:text="${#lists.size(posts.?[type.name() == 'EVENT'])}">0</h3>
          <p class="mb-0 text-muted">Eventos</p>
        </div>
      </div>
    </div>

    <!-- Card de Criar Post -->
    <div class="create-post-card">
      <h4 class="mb-3"><i class="bi bi-pencil-square text-primary"></i> Criar Novo Post</h4>
      <form th:action="@{/posts}" method="post">
        <div class="mb-3">
          <label for="content" class="form-label">Conteúdo do Post</label>
          <textarea class="form-control" id="content" name="content" rows="3" 
                    placeholder="Compartilhe uma informação, aviso ou evento..." 
                    maxlength="500" required></textarea>
          <div class="form-text">Máximo de 500 caracteres</div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <label for="type" class="form-label">Tipo do Post</label>
            <select class="form-select" id="type" name="type" required>
              <option th:each="postType : ${postTypes}" 
                      th:value="${postType}" 
                      th:text="${postType.name()}">
              </option>
            </select>
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-send"></i> Publicar Post
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Lista de Posts -->
    <div th:if="${#lists.isEmpty(posts)}" class="empty-state">
      <i class="bi bi-chat-dots" style="font-size: 4rem;"></i>
      <h3 class="mt-3">Nenhum post ainda</h3>
      <p class="text-muted">Seja o primeiro a compartilhar uma informação!</p>
    </div>

    <div th:unless="${#lists.isEmpty(posts)}">
      <!-- Posts Fixados -->
      <div th:if="${#lists.size(posts.?[pinned])} > 0" class="mb-4">
        <h4 class="mb-3"><i class="bi bi-pin-angle text-warning"></i> Posts Fixados</h4>
        <div th:each="post : ${posts.?[pinned]}" th:classappend="${post.pinned} ? 'pinned' : ''" class="post-card">
          <div class="post-header">
            <div class="d-flex justify-content-between align-items-start">
              <div class="d-flex align-items-center">
                <div class="author-avatar me-3">
                  <span th:text="${post.author.name.substring(0, 1).toUpperCase()}"></span>
                </div>
                <div>
                  <h6 class="mb-0" th:text="${post.author.name}"></h6>
                  <small class="text-muted" th:text="${post.author.email}"></small>
                </div>
              </div>
              <div class="text-end">
                <span class="pinned-indicator">
                  <i class="bi bi-pin-angle-fill"></i> Fixado
                </span>
                <div class="time-ago mt-1" th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}"></div>
              </div>
            </div>
          </div>
          
          <div class="post-body">
            <p class="mb-2" th:text="${post.content}"></p>
            <span th:class="'badge badge-type badge-' + ${post.type.name().toLowerCase()}" 
                  th:text="${post.type.name()}">
            </span>
          </div>
          
          <div class="post-footer">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                <i class="bi bi-clock"></i> 
                Atualizado em: <span th:text="${#temporals.format(post.updatedAt, 'dd/MM/yyyy HH:mm')}"></span>
              </small>
              <div th:if="${usuario.id == post.author.id or usuario.type == 'Professor'}">
                <form th:action="@{/posts/{id}/pin(id=${post.id})}" method="post" class="d-inline">
                  <button type="submit" class="btn btn-outline-warning btn-sm btn-action">
                    <i class="bi bi-pin-angle"></i> Desfixar
                  </button>
                </form>
                <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" class="d-inline" 
                      th:onsubmit="return confirm('Tem certeza que deseja excluir este post?')">
                  <button type="submit" class="btn btn-outline-danger btn-sm btn-action">
                    <i class="bi bi-trash"></i> Excluir
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Todos os Posts -->
      <h4 class="mb-3" th:if="${#lists.size(posts.?[pinned])} > 0">
        <i class="bi bi-chat-text"></i> Todos os Posts
      </h4>
      
      <div th:each="post : ${posts.?[!pinned]}" class="post-card">
        <div class="post-header">
          <div class="d-flex justify-content-between align-items-start">
            <div class="d-flex align-items-center">
              <div class="author-avatar me-3">
                <span th:text="${post.author.name.substring(0, 1).toUpperCase()}"></span>
              </div>
              <div>
                <h6 class="mb-0" th:text="${post.author.name}"></h6>
                <small class="text-muted" th:text="${post.author.email}"></small>
              </div>
            </div>
            <div class="time-ago" th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}"></div>
          </div>
        </div>
        
        <div class="post-body">
          <p class="mb-2" th:text="${post.content}"></p>
          <span th:class="'badge badge-type badge-' + ${post.type.name().toLowerCase()}" 
                th:text="${post.type.name()}">
          </span>
        </div>
        
        <div class="post-footer">
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              <i class="bi bi-clock"></i> 
              Atualizado em: <span th:text="${#temporals.format(post.updatedAt, 'dd/MM/yyyy HH:mm')}"></span>
            </small>
            <div th:if="${usuario.id == post.author.id or usuario.type == 'Professor'}">
              <form th:action="@{/posts/{id}/pin(id=${post.id})}" method="post" class="d-inline">
                <button type="submit" class="btn btn-outline-warning btn-sm btn-action">
                  <i class="bi bi-pin-angle"></i> Fixar
                </button>
              </form>
              <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" class="d-inline" 
                    th:onsubmit="return confirm('Tem certeza que deseja excluir este post?')">
                <button type="submit" class="btn btn-outline-danger btn-sm btn-action">
                  <i class="bi bi-trash"></i> Excluir
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Contador de caracteres para o textarea
    document.addEventListener('DOMContentLoaded', function() {
      const textarea = document.getElementById('content');
      const counter = document.createElement('div');
      counter.className = 'form-text text-end';
      counter.textContent = '0/500 caracteres';
      
      textarea.parentNode.appendChild(counter);
      
      textarea.addEventListener('input', function() {
        counter.textContent = `${this.value.length}/500 caracteres`;
        
        if (this.value.length > 500) {
          counter.classList.add('text-danger');
        } else {
          counter.classList.remove('text-danger');
        }
      });
    });
  </script>
</body>
</html>